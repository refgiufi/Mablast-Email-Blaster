<!DOCTYPE html>
<html>
<head>
  <title>MABLAST - Email-Blaster</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow-md">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-blue-600">üöÄ MABLAST</h1>
      <a href="/config" class="text-blue-600 hover:underline text-sm">‚öôÔ∏è Manage SMTP Config</a>
    </div>

    <form id="emailForm" class="space-y-4">
      <div>
        <label class="block font-medium">Select SMTP Config</label>
        <select name="smtp_config" class="w-full border p-2 rounded" required>
          {% for config in get_all_configs %}
            <option value="{{ config.id }}">{{ config.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block font-medium">Email Subject</label>
        <input type="text" name="subject" class="w-full border p-2 rounded" required>
      </div>

      <div>
        <label class="block font-medium">Email Body</label>
        <textarea name="body" rows="8" class="w-full border p-2 rounded" placeholder="Use <variable1>, <variable2>, etc. for dynamic variables" required></textarea>
      </div>

      <div>
        <label class="block font-medium">Content Type</label>
        <select name="email_type" class="w-full border p-2 rounded" required>
          <option value="text">Text</option>
          <option value="html">HTML</option>
        </select>
      </div>

      <div>
        <label class="block font-medium">Recipients List</label>
        <textarea name="recipients" rows="8" class="w-full border p-2 rounded" placeholder="One line per recipient:&#10;email@example.com, Name, Winner, Phone" required></textarea>
      </div>

      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">üì§ Blast Email</button>
    </form>

    <div id="progress" class="mt-6 space-y-2 text-sm"></div>
  </div>

  <script>
    const form = document.getElementById("emailForm");
    const progressDiv = document.getElementById("progress");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      progressDiv.innerHTML = "";

      const smtp_id = form.smtp_config.value;
      const subject = form.subject.value;
      const body = form.body.value;
      const is_html = form.email_type.value === "html";
      const lines = form.recipients.value.trim().split("\n");

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const statusEl = document.createElement("div");
        statusEl.innerHTML = `‚è≥ Sending to <strong>${line.split(",")[0]}</strong>...`;
        progressDiv.appendChild(statusEl);

        try {
          const res = await fetch("/send-one", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              smtp_id,
              subject,
              body,
              is_html,
              line
            })
          });

          const result = await res.json();
          if (result.status === "success") {
            statusEl.innerHTML = `‚úÖ <strong>${result.email}</strong> sent successfully`;
            statusEl.classList.add("text-green-600");
          } else {
            statusEl.innerHTML = `‚ùå <strong>${result.email}</strong> failed: ${result.error}`;
            statusEl.classList.add("text-red-600");
          }
        } catch (err) {
          statusEl.innerHTML = `‚ùå Error: ${err}`;
          statusEl.classList.add("text-red-600");
        }
      }
    });
  </script>
</body>
</html>
